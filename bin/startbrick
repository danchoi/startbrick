#!/usr/bin/env ruby

require 'optparse'

args = ARGV.dup

options = {:Host => 'localhost', :Port => '3000'}

opt_parser = OptionParser.new do |opts|
  opts.on("-p", "--port=port", Integer,
          "Runs Rails on the specified port.", "Default: 3000") { |v| options[:Port] = v }
  opts.on("-b", "--binding=ip", String,
          "Binds Rails to the specified ip.", "Default: 0.0.0.0") { |v| options[:Host] = v }
end

opt_parser.parse! args
puts options.inspect

cmd = "rails s #{ARGV.join(' ').strip}"

open_cmd = "open 'http://#{options[:Host]}:#{options[:Port]}'"
puts open_cmd
fork do
  `while ! nc -z localhost #{options[:Port]}; do sleep 0.1; done; echo 'opening browser'; #{open_cmd}`
end

puts cmd

exec cmd
